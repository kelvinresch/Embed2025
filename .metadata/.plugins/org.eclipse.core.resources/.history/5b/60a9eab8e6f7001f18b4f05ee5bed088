/* ECE3140Lab2.c
 *
 * Nils Napp
 * Cornell University
 * All right reserved
 *
 * Jan 2024
 * Ithaca NY
 *
 * This file is part of the ECE3140/CS3420 offering for Spring 2025. If you are not part
 * of this class you should not have access to this file. Do not post, share, or otherwise
 * distribute this file. We will consider it an AI violation if you do.
 */



.section .text
.global loop_3cycles
.global set_led
.type loop_3cycles %function

// PSOR and PCOR registers for PORTE
.equ	PSOR,			0x400FF104
.equ	PCOR,			0x400FF108
.equ	OUTPIN,			0x8

//Small timing loop to create predictable delays
loop_3cycles:
	SUB R0,#1
	BNE loop_3cycles
	BX LR

// void set_led(grb32_t rgb_val)
set_led:
	PUSH {R4-R7, LR}
	// So inside R0 is a 32-bit value.
	// R0[0-7] is the filler
	// R0[9-15] is the green intensity
	// R0[16-23] is the red intensity
	// R0[24-31] is the blue intensity

	// Remove filler
	LSL R0, R0, #8


	// Initialize pins
	LDR R1, =OUTPIN
	LDR R2, =PSOR
	LDR R3, =PCOR

	// Loop through the first 24 bits of R0
	MOV R5, #24
	loop:
	// Shift left one bit and store the value shifted out in C flag
	LSL R0, R0, #1
	// If 0, then branch to write zero
	BCC write_zero

	// IF 1, then branch to write one
	BCS write_one
	end:
	// Decrement R5 and loop
	SUB R5, #1
	BNE loop

	POP {R4-R7, PC}

// Pulse a short high and a long low on PTE3
// Uses R4
write_zero:
	// Set pin HIGH with PSOR
	STR R1, [R2]

	// Waste a cycle
	NOP
	NOP

	// Set pin LOW with PCOR
	STR R1, [R3]

	B end

// Pulse a long high and a long low on PTE3
// Uses R4
write_one:
	// Set pin HIGH with PSOR
	STR R1, [R2]

	// Spin for 10? cycles
	NOP
	NOP
	NOP
	NOP
	NOP
	NOP
	NOP
	NOP

	// Set pin LOW with PCOR
	STR R1, [R3]

	// Waste a cycle
	NOP

	B end







